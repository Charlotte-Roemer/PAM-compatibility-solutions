dim(df_filtered)
minutes(1)
minutes(2)
minutes(1.5)
intervals <- SM4_H_to_check %>%
filter(A_valider == 1) %>%
transmute(
lower = Datetime - seconds(90),
upper = Datetime + seconds(90)
)
Table_to_check <- SM4_H_to_check %>%
filter(map_lgl(Datetime, ~ any(.x >= intervals$lower & .x <= intervals$upper)))
View(Table_to_check)
dim(Table_to_check)
100/11
test = SM4_H_to_check %>% filter(A_valider ==1)
dim(test)
500/6
test = SM4_H_to_check %>% filter(A_valider ==1 & espece == "Pippip")
dim(test)
View(test)
test = SM4_H_to_check %>% filter(A_valider ==1 & espece == "Rhihip")
dim(test)
View(test)
dim(Table_to_check)
17768*1,2
17768*1.2
# Write
write_csv(Table_to_check, "/home/charlotte/Documents/Post-Doc/Stages/Laureen et Nathan/Analyse/Validations/Stage_Laureen_Nathan_pour_validation.csv")
library(tidyverse)
source("/home/charlotte/Documents/R/PAM-compatibility-solutions/Correction-factor/fun_for_bats.R")
source("/home/charlotte/Documents/R/PAM-compatibility-solutions/fun_for_bats.R")
# Function
Datetime_function <- function(x) #get date-time data from recording file names
{
if (is(x)[1] == "data.frame") {pretemps <- vector(length = nrow(x))}
op <- options(digits.secs = 3)
x = gsub(".wav", x, replacement = "")
pretemps <- paste(substr(x, nchar(x) - 18, nchar(x)-4), ".", substr(x, nchar(x) - 2, nchar(x)), sep = "")
strptime(pretemps, "%Y%m%d_%H%M%OS",tz="UTC")
}
# Load Observation file
Obs = read_delim("/home/charlotte/Documents/Post-Doc/Stages/Laureen et Nathan/Analyse/Obs_Stage_Laureen_Nathan_2025-10-22.csv")
# Load and bind Metadata files
Chemin_Metadata = "/home/charlotte/Documents/Post-Doc/MIGRATION/IN2P3/Scripts_IRODS/Dossiers traités"
TagMetadata = "Stage_Laureen_Nathan"
ListFilesMeta = list.files(paste0(Chemin_Metadata), full.names = T, recursive = TRUE, pattern = TagMetadata)
Metadata_All = data.frame()
for(i in 1:length(ListFilesMeta)){
Metadata_Temp = read_delim(ListFilesMeta[i], show_col_types=F)
Metadata_All = rbind(Metadata_All, Metadata_Temp)
}
names(Metadata_All)
Obs_Metadata = Metadata_All %>%
select(Site, Recorder, TriggerLevel, idsite, idparticipation) %>%
right_join(Obs, by = join_by(idparticipation == participation)) %>%
mutate(Recorder = Recorder_rename(Recorder)) %>%
select(-tadarida_taxon)
# Load bat list
Bat_List = read_csv2("/home/charlotte/Documents/Donnees vigie-chiro/SpeciesList.csv") %>%
filter(Group == "bat") %>%
select(Esp)
Bat_List = Bat_List$Esp
# Consider Batlogger A and Batlogger A+ the same machine
Obs_Metadata$Recorder = gsub("^Batlogger.*", "Batlogger", Obs_Metadata$Recorder)
# Add ID for Recorder + Sensitivity Level
Obs_Metadata$ID = paste0(Obs_Metadata$Recorder, "_", Obs_Metadata$TriggerLevel)
# Adapt Trigger Level so that it goes in the right direction
Obs_Metadata$TriggerLevel_adjusted = Obs_Metadata$TriggerLevel
Obs_Metadata$TriggerLevel_adjusted = ifelse(Obs_Metadata$Recorder!="Audiomoth",-Obs_Metadata$TriggerLevel, Obs_Metadata$TriggerLevel_adjusted)
Obs_Metadata$TriggerLevel_adjusted = ifelse(Obs_Metadata$Recorder=="Audiomoth" & Obs_Metadata$TriggerLevel==0, 100, Obs_Metadata$TriggerLevel_adjusted)
Obs_Metadata$TriggerLevel_adjusted = ifelse(Obs_Metadata$Recorder=="Audiomoth" & Obs_Metadata$TriggerLevel==5, 26, Obs_Metadata$TriggerLevel_adjusted)
# Create short names
Obs_Metadata$TriggerLevel_Short = Obs_Metadata$TriggerLevel_adjusted
Obs_Metadata$TriggerLevel_Short = ifelse(Obs_Metadata$TriggerLevel_adjusted==0, "High", Obs_Metadata$TriggerLevel_Short)
Obs_Metadata$TriggerLevel_Short = ifelse(Obs_Metadata$TriggerLevel_adjusted==-24, "Low", Obs_Metadata$TriggerLevel_Short)
Obs_Metadata$TriggerLevel_Short = ifelse(Obs_Metadata$TriggerLevel_adjusted==-10, "Low", Obs_Metadata$TriggerLevel_Short)
Obs_Metadata$TriggerLevel_Short = ifelse(Obs_Metadata$TriggerLevel_adjusted==26, "Low", Obs_Metadata$TriggerLevel_Short)
Obs_Metadata$TriggerLevel_Short = ifelse(Obs_Metadata$TriggerLevel_adjusted==27, "Medium", Obs_Metadata$TriggerLevel_Short)
Obs_Metadata$TriggerLevel_Short = ifelse(Obs_Metadata$TriggerLevel_adjusted==100, "High", Obs_Metadata$TriggerLevel_Short)
# Add ID for Recorder + Sensitivity Level
Obs_Metadata$ID = paste0(Obs_Metadata$Recorder, "_", Obs_Metadata$TriggerLevel_Short)
# Add date and time
Obs_Metadata$Datetime = Datetime_function(Obs_Metadata$donnee)
Obs_Metadata$Date = as.Date(Obs_Metadata$Datetime)
Obs_Metadata$Time = strftime(Obs_Metadata$Datetime, format="%H:%M:%S")
# Filter sites that are not complete, species that we don't need to check, and proba <0.5
Obs_Metadata_clean = Obs_Metadata %>%
mutate(espece = ifelse((espece == "Pleaur" | espece== "Pleaus" | espece== "Plemac"), "Plesp", espece)) %>%
filter(!Site %in% c("CE_0", "B1", "L3", "M4", "M3", "Z1"),
!(Site == "L1" & Datetime > "2025-05-24 09:00:00 UTC"),
espece %in% c("Nyclei", "Pipkuh", "Pippyg", "Rhihip", "Pippip", "Plesp"),
tadarida_probabilite > 0.5) %>%
arrange(Site, Datetime) %>%
select(Site, idparticipation, ID, donnee, Datetime, Date, Time, espece, tadarida_probabilite)
# Add column for check
SM4_H_to_check = Obs_Metadata_clean %>% # random stratified sampling by species and site
filter(ID == "SM4BAT_High") %>%
group_by(espece, Site) %>%
slice_sample(n=round(100/length(table(Obs_Metadata_clean$Site)))) %>%
mutate(A_valider = 1) %>%
right_join(Obs_Metadata_clean) %>%
arrange(Site, Datetime)
intervals <- SM4_H_to_check %>%
filter(A_valider == 1) %>%
transmute(
lower = Datetime - seconds(90),
upper = Datetime + seconds(90)
)
Table_to_check <- SM4_H_to_check %>%
filter(map_lgl(Datetime, ~ any(.x >= intervals$lower & .x <= intervals$upper)))
names(Table_to_check)
# Filter sites that are not complete, species that we don't need to check, and proba <0.5
Obs_Metadata_clean = Obs_Metadata %>%
mutate(espece = ifelse((espece == "Pleaur" | espece== "Pleaus" | espece== "Plemac"), "Plesp", espece)) %>%
filter(!Site %in% c("CE_0", "B1", "L3", "M4", "M3", "Z1"),
!(Site == "L1" & Datetime > "2025-05-24 09:00:00 UTC"),
espece %in% c("Nyclei", "Pipkuh", "Pippyg", "Rhihip", "Pippip", "Plesp"),
tadarida_probabilite > 0.5) %>%
arrange(Site, Datetime) %>%
select(Site, idsite, idparticipation, ID, donnee, Datetime, Date, Time, espece, tadarida_probabilite)
# Add column for check
SM4_H_to_check = Obs_Metadata_clean %>% # random stratified sampling by species and site
filter(ID == "SM4BAT_High") %>%
group_by(espece, Site) %>%
slice_sample(n=round(100/length(table(Obs_Metadata_clean$Site)))) %>%
mutate(A_valider = 1) %>%
right_join(Obs_Metadata_clean) %>%
arrange(Site, Datetime)
intervals <- SM4_H_to_check %>%
filter(A_valider == 1) %>%
transmute(
lower = Datetime - seconds(90),
upper = Datetime + seconds(90)
)
Table_to_check <- SM4_H_to_check %>%
filter(map_lgl(Datetime, ~ any(.x >= intervals$lower & .x <= intervals$upper)))
names(Table_to_check)
# Write
write_csv(Table_to_check, "/home/charlotte/Documents/Post-Doc/Stages/Laureen et Nathan/Analyse/Validations/Stage_Laureen_Nathan_pour_validation.csv")
cat("\n\n ============================================ \n")
cat(" --- 1. INITIALISATION DE L'ENVIRONNEMENT --- ")
cat("\n ============================================ \n")
## 1.1. Nettoyage de l’environnement ----
rm(list = ls())
gc()
## 1.2. Chargement des packages ----
# library(tidyverse) # No package
library(stringr)
# .==============================
# PARAMÈTRE : extraire fichiers voisins ?
# . ==============================
extraire_voisins <- TRUE  # Mettre FALSE pour désactiver l’extraction des fichiers n-1 et n+1
# .==============================================================================
# 2. CHARGEMENT DES DONNEES ----
# .==============================================================================
cat("\n\n ================================= \n")
cat(" --- 2. CHARGEMENT DES DONNEES --- ")
cat("\n ================================= \n")
## 2.1. Définir le chemin d'accès des données d'entrée ----
# Doit contenir les fichiers suivants :
#      * le fichier de sélection des wav avec les 3 colonnes suivantes :
#           - 'identifiant_site' : n° d'identification du site contenant la ou les participation(s)
#           - 'identifiant_participation' : n° d'identification de la ou des participation(s)
#           - 'nom_fichier' : nom des fichiers wav
#      * le fichier pexport de Vigie-chiro
#
# Ex : path_data <- "/sps/mnhn/vigiechiro/vigiechiro-prod-datastore/TempTiphaine/ExtractWav/input/"
path_data <- "/sps/mnhn/vigiechiro/vigiechiro-prod-datastore/TempBMRE/checkfiles_stage_LN/input/" #*** A ADAPTER
## 2.2. Définir le chemin dans lequel les fichiers wav seront stockés ----
# Ex : dir_out <- "/sps/mnhn/vigiechiro/vigiechiro-prod-datastore/TempTiphaine/ExtractWav/"
dir_out <- "/sps/mnhn/vigiechiro/vigiechiro-prod-datastore/TempBMRE/checkfiles_stage_LN/" #*** A ADAPTER
library(tidyverse)
Metadata_site_info <- read_delim("/home/charlotte/Bureau/Metadata_table.csv", show_col_types = FALSE)
head(Metadata_site_info)
Donnee = "w52u384_20220703T224029+0200_N57.807E13.2558_TE384_30kHz-22dB.ta"
library(tidyverse)
grepl(".*?(([0-9]{8}_[0-9]{6})(_([0-9]{3}))?).*?$", Donnee)
Donnee2 = "blable20251024_200425_000.wac"
grepl(".*?(([0-9]{8}_[0-9]{6})(_([0-9]{3}))?).*?$", Donnee2)
grepl(".*?(([0-9]{4}-[0-9]{2}-[0-9]{2}_[0-9]{2}-[0-9]{2}-[0-9]{2})).*?$", Donnee)
grepl(".*?(([0-9]{4}-[0-9]{2}-[0-9]{2}_[0-9]{2}-[0-9]{2}-[0-9]{2})).*?$", Donnee2)
Donnee = "w52u384_20220703_224029+0200_N57.807E13.2558_TE384_30kHz-22dB.ta"
grepl(".*?(([0-9]{8}_[0-9]{6})(_([0-9]{3}))?).*?$", Donnee)
grepl(".*?([0-9]{8}_[0-9]{6})(_[0-9]{3})?.*", Donnee)
grepl(".*?[0-9]{8}T[0-9]{6}[+-][0-9]{4}.*", Donnee)
grepl(".*?(([0-9]{8}T[0-9]{6})(_([0-9]{3}))?).*?$", Donnee2)
grepl(".*?(([0-9]{8}T[0-9]{6})).*?$", Donnee2)
grepl(".*?(([0-9]{8}T[0-9]{6})(_([0-9]{3}))?).*?$", Donnee)
grepl(".*?(([0-9]{8}T[0-9]{6})?).*?$", Donnee)
contient_date_heure_T <- function(nom_fichier) {
grepl(".*?[0-9]{8}T[0-9]{6}[+-][0-9]{4}.*", nom_fichier)
}
# Exemple d'utilisation
Donnee <- "w52u384_20220703T224029+0200_N57.807E13.2558_TE384_30kHz-22dB.ta"
contient_date_heure_T(Donnee)  # Retourne TRUE
grepl(".*?[0-9]{8}T[0-9]{6}[+-][0-9]{4}.*", Donnee)
Donnee = "w52u384_20220703T224029+0200_N57.807E13.2558_TE384_30kHz-22dB.ta"
grepl(".*?[0-9]{8}T[0-9]{6}[+-][0-9]{4}.*", Donnee)
Timestamp_Fich <- sub(".*?[0-9]{8}T[0-9]{6}[+-][0-9]{4}.*", "\\1", Donnee)
Timestamp_Fich
Timestamp_Fich <- sub(".*?[0-9]{8}T[0-9]{6}.*", "\\1", Donnee)
Timestamp_Fich
Timestamp_Fich <- sub(".*?([0-9]{8}T[0-9]{6}).*", "\\1", Donnee)
Timestamp_Fich
sub("T", "_", Timestamp_Fich)
Timestamp_Fich <- sub("T", "_", Timestamp_Fich)
TimeModMetadata_m <- as.POSIXct(Timestamp_Fich, format = "%Y-%m-%d_%H-%M-%S", tz = "UTC")
TimeModMetadata_m
TimeModMetadata_m <- as.POSIXct(Timestamp_Fich, format = "%Y%m%d_%H%M%S", tz = "UTC")
TimeModMetadata_m
Metadata_site_info <- read_delim("/home/charlotte/Bureau/Metadata_table.csv", show_col_types = FALSE)
Metadata_site_info$start_time <- dmy_hms(paste0(Metadata_site_info$StartDate, " ", Metadata_site_info$StartTime))
Metadata_site_info$start_time
Metadata_site_info <- Metadata_site_info %>%
filter(Site == "wurb52" & Participation == "Tolken-1_2022-07-03")
Metadata_site_info$start_time <- dmy_hms(paste0(Metadata_site_info$StartDate, " ", Metadata_site_info$StartTime))
Metadata_site_info$start_time
Metadata_site_info$StartTime
class(Metadata_site_info$StartTime)
hm(Metadata_site_info$StartTime)
hms(Metadata_site_info$StartTime)
hm(hms(Metadata_site_info$StartTime))
hms(Metadata_site_info$StartTime)
Metadata_site_info$StartTime = "21:54"
class(Metadata_site_info$StartTime)
hm(Metadata_site_info$StartTime)
class(hm(Metadata_site_info$StartTime))
Metadata_site_info <- read_delim("/home/charlotte/Bureau/Metadata_table.csv", show_col_types = FALSE)
Metadata_site_info <- Metadata_site_info %>%
filter(Site == "wurb52" & Participation == "Tolken-1_2022-07-03")
Metadata_site_info$StartTime
substr(Metadata_site_info$StartTime, 2, 3)
substr(Metadata_site_info$StartTime, 1, 5)
class(substr(Metadata_site_info$StartTime, 1, 5))
as_hm(Metadata_site_info$StartTime)
library(hms)
as_hm(Metadata_site_info$StartTime)
hm(Metadata_site_info$StartTime)
hm(as.character(Metadata_site_info$StartTime))
(as.character(Metadata_site_info$StartTime))
Metadata_site_info$StartTime
dmy_hms(paste0(Metadata_site_info$StartDate, " ", Metadata_site_info$StartTime))
hms(Metadata_site_info$StartTime)
paste0(Metadata_site_info$StartDate, " ", Metadata_site_info$StartTime)
class(Metadata_site_info$StartDate)
Metadata_site_info$StartDate
dmy("02/02/2025")
TimeModMetadata_m
day(TimeModMetadata_m)
class(Metadata_site_info$StartTime)
is.difftime(Metadata_site_info$StartTime)
paste0(Metadata_site_info$StartDate, " ", Metadata_site_info$StartTime))
paste0(Metadata_site_info$StartDate, " ", Metadata_site_info$StartTime)
ymd_hms(paste0(Metadata_site_info$StartDate, " ", Metadata_site_info$StartTime))paste0(Metadata_site_info$StartDate, " ", Metadata_site_info$StartTime)
ymd_hms(paste0(Metadata_site_info$StartDate, " ", Metadata_site_info$StartTime))
class(ymd_hms(paste0(Metadata_site_info$StartDate, " ", Metadata_site_info$StartTime)))
rep_list = "/home/charlotte/Bureau/Testdata_buzz_classifier/TestData_FeedingBuzzClassifier_Hendel_20241206-5s/Myotis_FB/txt"
rep_list = "/home/charlotte/Bureau/Testdata_buzz_classifier/TestData_FeedingBuzzClassifier_Hendel_20241206-5s/Myotis_FB/txt"
ListFilesMeta = list.files(paste0(Chemin_Metadata), full.names = T, recursive = TRUE, pattern = ".ta$")
ListFilesMeta = list.files(paste0(rep_list), full.names = T, recursive = TRUE, pattern = ".ta$")
ListFilesMeta
ListWrecent = list.files(paste0(rep_list), full.names = T, recursive = TRUE, pattern = ".ta$")
Ta_All <- data.frame()
for (i in 1:length(ListWrecent)) {
Ta_Temp <- read_delim(ListWrecent[i], show_col_types = F)
Ta_All <- rbind(Ta_All, Ta_Temp)
}
head(Ta_All)
head(as.data.frame(Ta_All))
max(Ta_All$FileDur)
exists("TimeModMetadata_m")
TimeModMetadata_m = "bma"
exists("TimeModMetadata_m")
TimeModMetadata_m = "fzezefzg.ta"
"ta" %in% TimeModMetadata_m
grepl(".ta", TimeModMetadata_m)
grepl(".wav", TimeModMetadata_m)
library(tidyverse)
repertory = "/home/charlotte/Documents/Post-Doc/Stages/Laureen et Nathan/Analyse"
data_agr<-read_delim(paste0(repertory, "Activity_file.csv"))
repertory = "/home/charlotte/Documents/Post-Doc/Stages/Laureen et Nathan/Analyse"
data_agr<-read_delim(paste0(repertory, "Activity_file.csv"))
repertory = "/home/charlotte/Documents/Post-Doc/Stages/Laureen et Nathan/Analyse/"
data_agr<-read_delim(paste0(repertory, "Activity_file.csv"))
head(data_agr)
library(tidyverse)
#### Load files and define values ####
setwd("/home/charlotte/Documents/R/PAM-compatibility-solutions/Correction-factor")
source("fun_for_bats.R")
setwd("/home/charlotte/Documents/R/PAM-compatibility-solutions")
source("fun_for_bats.R")
library(tidyverse)
setwd("/home/charlotte/Documents/R/PAM-compatibility-solutions/R Scripts")
source("fun_for_bats.R")
# Filter probabilities by...
Filter_proba = c(0.5, 0.9)
# Time interval: "5 seconds", "minute", "5 minutes", "10 minutes", "hour"
Time_interval = "5 seconds"
# Load Observation results
Obs = read_delim("/home/charlotte/Documents/Post-Doc/Stages/Laureen et Nathan/Analyse/Obs_Stage_Laureen_Nathan_2025-10-27.csv")
# Load and bind Metadata files
Chemin_Metadata = "/home/charlotte/Documents/Post-Doc/MIGRATION/IN2P3/Scripts_IRODS/Dossiers traités"
TagMetadata = "Stage_Laureen_Nathan"
ListFilesMeta = list.files(paste0(Chemin_Metadata), full.names = T, recursive = TRUE, pattern = TagMetadata)
Metadata_All = data.frame()
for(i in 1:length(ListFilesMeta)){
Metadata_Temp = read_delim(ListFilesMeta[i], show_col_types=F)
Metadata_All = rbind(Metadata_All, Metadata_Temp)
}
# Load Distance information
Distance_veg = read_delim("/home/charlotte/Documents/Post-Doc/Stages/Laureen et Nathan/Analyse/Distance.csv")
# Time interval: "5 seconds", "minute", "5 minutes", "10 minutes", "hour"
Time_interval = "minute"
head(as.data.frame(Obs))
df = Obs
round_to = "minute"
head(df %>%
mutate(DateNight = DateNightFun(donnee))) %>% as.data.frame()
Filename = "Car340582-2025-Pass1-Z8-20250429_001705_000"
grepl(".wav", Filename)
test = "Car340582-2025-Pass1-Z8-20250429_001705_000.wav"
grepl(".wav", test)
as.character(as.Date(paste(str_sub(Filename,-16+nchar,-13+nchar),
str_sub(Filename,-12+nchar,-11+nchar),
str_sub(Filename,-10+nchar,-9+nchar),
sep="-")))
nchar = ifelse(grepl(".wav", Filename), 3, 0)
nchar
as.character(as.Date(paste(str_sub(Filename,-16+nchar,-13+nchar),
str_sub(Filename,-12+nchar,-11+nchar),
str_sub(Filename,-10+nchar,-9+nchar),
sep="-")))
as.character(paste(str_sub(Filename,-16+nchar,-13+nchar),
str_sub(Filename,-12+nchar,-11+nchar),
str_sub(Filename,-10+nchar,-9+nchar),
sep="-"))
Filename
str_sub(Filename,-16+nchar,-13+nchar)
str_sub(Filename,-21+nchar,-19+nchar)
Filename,-19+nchar,-16+nchar)
str_sub(Filename,-19+nchar,-16+nchar)
as.character(paste(str_sub(Filename,-19+nchar,-16+nchar),
str_sub(Filename,-15+nchar,-14+nchar),
str_sub(Filename,-13+nchar,-12+nchar),
sep="-"))
as.character(paste(str_sub(Filename,-10+nchar,-9+nchar),
str_sub(Filename,-9+nchar,-8+nchar),
str_sub(Filename,-8+nchar,-7+nchar),
sep="-"))
Filename
as.character(paste(str_sub(Filename,-10+nchar,-9+nchar),
str_sub(Filename,-8+nchar,-7+nchar),
str_sub(Filename,-6+nchar,-5+nchar),
sep="-"))
DateTemp = as.character(paste(str_sub(Filename,-19+nchar,-16+nchar),
str_sub(Filename,-15+nchar,-14+nchar),
str_sub(Filename,-13+nchar,-12+nchar),
sep="-"))
TimeTemp = as.character(paste(str_sub(Filename,-10+nchar,-9+nchar),
str_sub(Filename,-8+nchar,-7+nchar),
str_sub(Filename,-6+nchar,-5+nchar),
sep=":"))
TimeTemp
as.POSIXct(paste0(DateTemp, " ", TimeTemp))
#### DATE TIME FROM FILE NAME ####
DateNightFun <- function(Filename) {
nchar = ifelse(grepl(".wav", Filename), 3, 0)
DateTemp = as.character(paste(str_sub(Filename,-19+nchar,-16+nchar),
str_sub(Filename,-15+nchar,-14+nchar),
str_sub(Filename,-13+nchar,-12+nchar),
sep="-"))
TimeTemp = as.character(paste(str_sub(Filename,-10+nchar,-9+nchar),
str_sub(Filename,-8+nchar,-7+nchar),
str_sub(Filename,-6+nchar,-5+nchar),
sep=":"))
DateTime = as.POSIXct(paste0(DateTemp, " ", TimeTemp))
}
#### DATE TIME FROM FILE NAME ####
DateTimefun <- function(Filename) {
nchar = ifelse(grepl(".wav", Filename), 3, 0)
DateTemp = as.character(paste(str_sub(Filename,-19+nchar,-16+nchar),
str_sub(Filename,-15+nchar,-14+nchar),
str_sub(Filename,-13+nchar,-12+nchar),
sep="-"))
TimeTemp = as.character(paste(str_sub(Filename,-10+nchar,-9+nchar),
str_sub(Filename,-8+nchar,-7+nchar),
str_sub(Filename,-6+nchar,-5+nchar),
sep=":"))
DateTime = as.POSIXct(paste0(DateTemp, " ", TimeTemp))
}
#### DATE NIGHT FROM FILE NAME ####
DateNightFun <- function(Filename) {
DateNightResult= as.Date(ifelse(str_sub(Filename,-10,-10)==0, #Attention si ".wav" ou pas =+/-3 characteres
as.character(as.Date(paste(str_sub(Filename,-19,-16),
str_sub(Filename,-15,-14),
str_sub(Filename,-13,-12),
sep="-"))-1),
as.character(as.Date(paste(str_sub(Filename,-19,-16),
str_sub(Filename,-15,-14),
str_sub(Filename,-13,-12),
sep="-")))))
}
head(df %>%
mutate(DateNight = DateNightFun(donnee))) %>% as.data.frame()
head(df %>%
mutate(DateNight = DateTimefun(donnee))) %>% as.data.frame()
#### DATE TIME FROM FILE NAME ####
DateTimefun <- function(Filename) {
nchar = ifelse(grepl(".wav", Filename), 3, 0)
DateTemp = as.character(paste(str_sub(Filename,-19+nchar,-16+nchar),
str_sub(Filename,-15+nchar,-14+nchar),
str_sub(Filename,-13+nchar,-12+nchar),
sep="-"))
TimeTemp = as.character(paste(str_sub(Filename,-10+nchar,-9+nchar),
str_sub(Filename,-8+nchar,-7+nchar),
str_sub(Filename,-6+nchar,-5+nchar),
sep=":"))
as.POSIXct(paste0(DateTemp, " ", TimeTemp))
}
head(df %>%
mutate(DateNight = DateTimefun(donnee))) %>% as.data.frame()
DateTemp = as.character(paste(str_sub(Filename,-19+nchar,-16+nchar),
str_sub(Filename,-15+nchar,-14+nchar),
str_sub(Filename,-13+nchar,-12+nchar),
sep="-"))
TimeTemp = as.character(paste(str_sub(Filename,-10+nchar,-9+nchar),
str_sub(Filename,-8+nchar,-7+nchar),
str_sub(Filename,-6+nchar,-5+nchar),
sep=":"))
as.POSIXct(paste0(DateTemp, " ", TimeTemp))
head(df)
head(df$donnee)
#### DATE TIME FROM FILE NAME ####
DateTimefun <- function(Filename) {
nchar = ifelse(grepl(".wav", Filename), 3, 0)
DateTemp = as.character(paste(str_sub(Filename,-(19+nchar),-(16+nchar)),
str_sub(Filename,-(15+nchar),-(14+nchar)),
str_sub(Filename,-(13+nchar),-(12+nchar)),
sep="-"))
TimeTemp = as.character(paste(str_sub(Filename,-(10+nchar),-(9+nchar)),
str_sub(Filename,-(8+nchar),-(7+nchar)),
str_sub(Filename,-(6+nchar),-(5+nchar)),
sep=":"))
as.POSIXct(paste0(DateTemp, " ", TimeTemp))
}
head(df %>%
mutate(datetime = DateTimefun(donnee)))
class(df$donnee)
as.POSIXct(paste0(DateTemp, " ", TimeTemp))
class(as.POSIXct(paste0(DateTemp, " ", TimeTemp)))
as.POSIXt(paste0(DateTemp, " ", TimeTemp))
as.POSIXlt(paste0(DateTemp, " ", TimeTemp))
class(as.POSIXlt(paste0(DateTemp, " ", TimeTemp)))
#### DATE TIME FROM FILE NAME ####
DateTimefun <- function(Filename) {
nchar = ifelse(grepl(".wav", Filename), 3, 0)
DateTemp = as.character(paste(str_sub(Filename,-(19+nchar),-(16+nchar)),
str_sub(Filename,-(15+nchar),-(14+nchar)),
str_sub(Filename,-(13+nchar),-(12+nchar)),
sep="-"))
TimeTemp = as.character(paste(str_sub(Filename,-(10+nchar),-(9+nchar)),
str_sub(Filename,-(8+nchar),-(7+nchar)),
str_sub(Filename,-(6+nchar),-(5+nchar)),
sep=":"))
as.POSIXlt(paste0(DateTemp, " ", TimeTemp))
}
head(df %>%
mutate(datetime = DateTimefun(donnee)))
class(DateTemp)
class(TimeTemp)
class(paste0(DateTemp, " ", TimeTemp))
#### DATE TIME FROM FILE NAME ####
DateTimefun <- function(Filename) {
nchar = ifelse(grepl(".wav", Filename), 3, 0)
DateTemp = as.character(paste(str_sub(Filename,-(19+nchar),-(16+nchar)),
str_sub(Filename,-(15+nchar),-(14+nchar)),
str_sub(Filename,-(13+nchar),-(12+nchar)),
sep="-"))
TimeTemp = as.character(paste(str_sub(Filename,-(10+nchar),-(9+nchar)),
str_sub(Filename,-(8+nchar),-(7+nchar)),
str_sub(Filename,-(6+nchar),-(5+nchar)),
sep=":"))
paste0(DateTemp, " ", TimeTemp)
}
head(df %>%
mutate(datetime = DateTimefun(donnee)))
head(df %>%
mutate(datetime = DateTimefun(donnee))) %>% as.data.frame()
df %>%
mutate(datetime = as.POSIXct(DateTimefun(donnee))) %>% as.data.frame() %>%  head()
head(df %>%
mutate(datetime = as.POSIXct(DateTimefun(donnee), format = "%Y-%m-%d %H:%M:%S")))
head(df %>%
mutate(datetime = as.POSIXct(DateTimefun(donnee), format = "%Y-%m-%d %H:%M:%S")) %>%  as.data.frame())
#### AGGREGATE DETECTIONS ####
aggregate_detections <- function(df, round_to) {
df %>%
mutate(datetime = as.POSIXct(DateTimefun(donnee), format = "%Y-%m-%d %H:%M:%S")) %>%
mutate(datetime = floor_date(datetime, unit = round_to)) %>%
mutate(night_start = if_else(hour(datetime) >= 17 & hour(datetime) < 24, as.Date(datetime), as.Date(datetime) - 1))%>%
group_by(datetime, participation, espece) %>%
top_n(1, tadarida_probabilite) %>% # keep max probability
distinct(datetime, participation, espece) %>%
ungroup()
}
Test = aggregate_detections (Obs)
# Aggregate data if time interval is higher than 5 seconds
if(Time_interval != "5 seconds") {
Test = aggregate_detections (Obs, Time_interval)
}
head(Test)
